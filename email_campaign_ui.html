<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Email Campaign UI</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f7f7f7; }
        .container { background: #fff; padding: 2em; border-radius: 8px; max-width: 500px; margin: auto; box-shadow: 0 2px 8px #ccc; }
        label { display: block; margin-top: 1em; }
        input[type="text"], textarea { width: 100%; padding: 0.5em; margin-top: 0.2em; border: 1px solid #ccc; border-radius: 4px; }
        input[type="file"] { margin-top: 0.5em; }
        button { margin-top: 1.5em; padding: 0.7em 2em; background: #0078d7; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005fa3; }
        .preview { background: #f0f0f0; padding: 1em; border-radius: 4px; margin-top: 1em; }
    </style>
</head>
<body>
<div class="container">
    <h2>Email Campaign UI</h2>
    <form id="campaignForm">
        <label for="csvFile">CSV File:</label>
        <input type="file" id="csvFile" accept=".csv" required>

        <div id="personSelectDiv" class="person-list" style="display:none;"></div>

        <label for="template">Email Template:</label>
        <select id="template">
            <option value="hr">HR Reminder</option>
            <option value="tow">Towing Warning</option>
            <option value="customs">Customs Notice</option>
        </select>


        <label for="context">Context/Details:</label>
        <small style="color:#555;display:block;margin-bottom:0.5em;">This will be appended to the email body for all selected recipients, allowing you to personalize or target the message (e.g., department, event, or custom note).</small>
        <textarea id="context" rows="3" placeholder="Enter target details or context..."></textarea>

        <button type="button" onclick="previewEmails()">Preview Emails</button>
        <button type="submit">Send Emails</button>
    </form>
    <div id="preview" class="preview" style="display:none;"></div>
</div>
<script>
let contacts = [];

const templates = {
    hr: {
        subject: "HR Reminder: Confirm Your Contact Details",
        body: "Please review and confirm your contact details by July 15 to ensure our records are up to date.",
        tags: [
            "Phishing: Spearphishing via Service (T1194)",
            "Impersonation: HR Department"
        ]
    },
    tow: {
        subject: "Urgent: Vehicle Towing Notice",
        body: "Attention: Your vehicle is scheduled for towing due to a parking violation. To avoid immediate towing and resolve this issue, please visit the following link: [LINK]\nFailure to respond within 24 hours may result in additional fees.",
        tags: [
            "Phishing: Spearphishing via Service (T1194)",
            "Urgency/Threat: Immediate Action Required",
            "Pretext: Vehicle Violation"
        ]
    },
    customs: {
        subject: "Action Required: Package Held at Customs",
        body: "Dear Customer,\n\nYour package is currently being held at customs due to missing information. To release your package and avoid return or additional charges, please complete the required form at the following link: [LINK]\nYou may also scan the following QR code to resolve the issue: [QR CODE]\n\nThank you for your prompt attention.",
        tags: [
            "Phishing: Spearphishing via Service (T1194)",
            "Pretext: Delivery/Logistics",
            "Impersonation: Customs/Shipping"
        ]
    }
};

function sanitizeContext(context) {
    // Remove non-printable ASCII characters
    return context.replace(/[^\x20-\x7E]/g, '');
}

function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    return lines.slice(1).map(line => {
        const values = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : '');
        // Strip spaces from email
        if (obj.email) obj.email = obj.email.trim();
        return obj;
    });
}

document.getElementById('csvFile').addEventListener('change', function() {
    const fileInput = document.getElementById('csvFile');
    const personSelectDiv = document.getElementById('personSelectDiv');
    if (!fileInput.files.length) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        contacts = parseCSV(e.target.result);
        let html = '<b>Select Recipients:</b><br>';
        contacts.forEach((person, idx) => {
            html += `<label><input type='checkbox' class='personCheck' value='${idx}' checked> ${person.name || person.email}</label><br>`;
        });
        personSelectDiv.innerHTML = html;
        personSelectDiv.style.display = 'block';
    };
    reader.readAsText(fileInput.files[0]);
});

function previewEmails() {
    const contextRaw = document.getElementById('context').value;
    const context = sanitizeContext(contextRaw);
    const previewDiv = document.getElementById('preview');
    const templateKey = document.getElementById('template').value;
    const template = templates[templateKey];
    const checked = Array.from(document.getElementsByClassName('personCheck')).filter(cb => cb.checked);
    if (!checked.length) {
        alert('Please select at least one recipient.');
        return;
    }
    let html = '';
    checked.forEach(cb => {
        const person = contacts[cb.value];
        html += `<b>To:</b> ${person.email || ''}<br>`;
        html += `<b>Subject:</b> ${template.subject}<br>`;
        html += `<b>Body:</b><br> ${template.body}`;
        if (context) html += `<br><br>${context}`;
        if (template.tags && template.tags.length) {
            html += `<br><b>Threat Tags:</b> <span style='color:#b00'>${template.tags.join(', ')}</span>`;
        }
        html += '<hr>';
    });
    previewDiv.innerHTML = html;
    previewDiv.style.display = 'block';

    // Add export buttons below preview
    const exportHtmlBtn = document.createElement('button');
    exportHtmlBtn.textContent = 'Export as HTML';
    exportHtmlBtn.onclick = function() { exportPreviews('html'); };
    const exportJsonBtn = document.createElement('button');
    exportJsonBtn.textContent = 'Export as JSON';
    exportJsonBtn.onclick = function() { exportPreviews('json'); };
    const exportPdfBtn = document.createElement('button');
    exportPdfBtn.textContent = 'Export as PDF';
    exportPdfBtn.onclick = function() { exportPreviews('pdf'); };
    previewDiv.parentNode.insertBefore(exportHtmlBtn, previewDiv.nextSibling);
    previewDiv.parentNode.insertBefore(exportJsonBtn, exportHtmlBtn.nextSibling);
    previewDiv.parentNode.insertBefore(exportPdfBtn, exportJsonBtn.nextSibling);
}

function exportPreviews(format) {
    const contextRaw = document.getElementById('context').value;
    const context = sanitizeContext(contextRaw);
    const templateKey = document.getElementById('template').value;
    const template = templates[templateKey];
    const checked = Array.from(document.getElementsByClassName('personCheck')).filter(cb => cb.checked);
    if (!checked.length) {
        alert('Please select at least one recipient.');
        return;
    }
    let exports = [];
    checked.forEach(cb => {
        const person = contacts[cb.value];
        exports.push({
            to: person.email || '',
            subject: template.subject,
            body: template.body,
            context: context,
            tags: template.tags
        });
    });
    if (format === 'html') {
        let html = '<html><body>';
        exports.forEach(e => {
            html += `<b>To:</b> ${e.to}<br>`;
            html += `<b>Subject:</b> ${e.subject}<br>`;
            html += `<b>Body:</b><br> ${e.body}`;
            if (e.context) html += `<br><br>${e.context}`;
            // Add two empty lines before MITRE tag
            html += '<br><br>';
            if (e.tags && e.tags.length) {
                html += `<b>Threat Tags:</b> <span style='color:#b00'>${e.tags.join(', ')}</span>`;
            }
            html += '<hr>';
        });
        html += '</body></html>';
        const blob = new Blob([html], {type: 'text/html'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'email_previews.html';
        link.click();
    } else if (format === 'json') {
        const blob = new Blob([JSON.stringify(exports, null, 2)], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'email_previews.json';
        link.click();
    } else if (format === 'pdf') {
        if (typeof window.jspdf === 'undefined') {
            alert('jsPDF library not loaded yet. Please wait a moment and try again.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 10;
        exports.forEach(e => {
            doc.setFontSize(12);
            doc.text(`To: ${e.to}`, 10, y, {maxWidth: 180});
            y += 7;
            doc.text(`Subject: ${e.subject}`, 10, y, {maxWidth: 180});
            y += 7;
            doc.text('Body:', 10, y);
            y += 7;
            // Wrap body/context
            let bodyLines = doc.splitTextToSize(e.body, 180);
            bodyLines.forEach(line => { doc.text(line, 10, y); y += 7; });
            if (e.context) {
                let contextLines = doc.splitTextToSize(e.context, 180);
                contextLines.forEach(line => { doc.text(line, 10, y); y += 7; });
            }
            // Add empty line before MITRE tag
            y += 7;
            if (e.tags && e.tags.length) {
                doc.setTextColor(180,0,0);
                let tagsLine = `Threat Tags: ${e.tags.join(', ')}`;
                let tagsLines = doc.splitTextToSize(tagsLine, 180);
                tagsLines.forEach(line => { doc.text(line, 10, y); y += 7; });
                doc.setTextColor(0,0,0);
            }
            doc.line(10, y, 200, y);
            y += 10;
            if (y > 270) { doc.addPage(); y = 10; }
        });
        doc.save('email_previews.pdf');
    }
}

document.getElementById('campaignForm').onsubmit = function(e) {
    e.preventDefault();
    alert('This demo UI does not actually send emails. Integrate with your backend to enable sending.');
};

// Add jsPDF CDN
if (!document.getElementById('jspdf-script')) {
    var script = document.createElement('script');
    script.id = 'jspdf-script';
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    document.head.appendChild(script);
}
</script>
</body>
</html>
